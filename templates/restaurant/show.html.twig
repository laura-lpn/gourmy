{% extends 'base.html.twig' %}

{% block title %}
	{{ restaurant.name }}
{% endblock %}

{% block body %}
	<div class="w-3/4 mx-auto px-6 py-8 mt-28">
		<section
			class="flex flex-col md:flex-row gap-12 items-start relative">
			{# Bouton favoris #}
			<button class="absolute top-0 right-0 text-white text-lg z-20 bg-orange rounded-full pt-1 pb-0.5 px-2 favorite-btn" data-id="{{ restaurant.id }}">
				<i class="{{ isFavorite ? 'fa-solid' : 'fa-regular' }} fa-heart"></i>
			</button>
			<div class="relative md:w-1/2 w-full">
				{% if restaurant.bannerName %}
					<img src="{{ vich_uploader_asset(restaurant, 'bannerFile') }}" alt="Image de {{ restaurant.name }}" class="rounded-xl w-full h-80 object-cover">
				{% endif %}
				<div class="absolute -bottom-5 -right-5 w-20 h-20 bg-white rounded-full shadow-lg flex items-center justify-center">
					<img src="{{ asset('images/chef-hat-blue.svg') }}" alt="Badge" class="w-16 h-16">
				</div>
			</div>

			<div class="flex-1">
				<h1 class="text-3xl font-second font-medium text-blue mb-2">{{ restaurant.name }}</h1>
				<p class="text-sm font-medium text-orange mb-3">
					{{ restaurant.types|map(t => t.name)|join(', ') }}
				</p>
				<p class="mb-4">{{ restaurant.description }}</p>

				<div class="flex items-center gap-1 text-orange mb-2">
					{% set avg = restaurant.averageRating %}
					{% for i in 1..5 %}
						<i class="fa{{ avg >= i ? 's' : (avg >= i - 0.5 ? 's' : 'r') }} fa-star text-sm"></i>
					{% endfor %}
					<span class="text-sm text-black ml-2">
						{{ restaurant.reviews|filter(r => not r.response)|length }}
						avis
					</span>
				</div>
			</div>
		</section>

		<section class="mt-12 flex flex-col md:flex-row gap-12 items-start">
			<div class="md:w-1/2 w-full space-y-2 bg-blue/5 rounded-xl p-6">
				<h2 class="text-xl font-medium flex gap-6 items-center font-second text-blue mb-4">
					<span class="h-0.5 rounded-md bg-blue w-8 block"></span>Infos pratiques
				</h2>
				<p>
					<strong class="font-medium">Adresse :</strong>
					{{ restaurant.address ~ ', ' ~ restaurant.postalCode ~ ' ' ~ restaurant.city ~ ', ' ~ restaurant.country }}</p>
				<p>
					<strong class="font-medium">Horaires :</strong>
					{{ restaurant.openingHours }}</p>
				<p>
					<strong class="font-medium">Tarifs :</strong>
					{{ restaurant.priceRange }}</p>
				{% if restaurant.phoneNumber %}
					<p>
						<strong class="font-medium">Téléphone :</strong>
						{{ restaurant.phoneNumber }}</p>
				{% endif %}
				{% if restaurant.website %}
					<p>
						<strong class="font-medium">Site Web :</strong>
						<a href="{{ restaurant.website }}" target="_blank" class="text-blue underline">{{ restaurant.website }}</a>
					</p>
				{% endif %}
				{% if restaurant.types is not empty %}
					<p>
						<strong class="font-medium">Types de cuisine :</strong>
						{{ restaurant.types|map(t => t.name)|join(', ') }}</p>
				{% endif %}
			</div>

			<div class="md:w-1/2 w-full">
				<map-preview address="{{ restaurant.address|e('html_attr') }}" postal-code="{{ restaurant.postalCode|e('html_attr') }}" city="{{ restaurant.city|e('html_attr') }}" country="{{ restaurant.country|e('html_attr') }}">
					<div id="map" class="rounded-xl" style="height: 400px; width: 100%;"></div>
				</map-preview>
			</div>
		</section>


		<section class="mt-12">
			<my-carousel title="Images du restaurant" visible="5">
				{% for image in restaurant.images %}
					<img src="{{ vich_uploader_asset(image, 'imageFile') }}" alt="Image de {{ restaurant.name }}" class="rounded-lg object-cover w-full h-auto aspect-square"/>
				{% endfor %}
				{% for review in imagesReviews %}
					<img src="{{ vich_uploader_asset(review, 'imageFile') }}" alt="Image de {{ restaurant.name }}" class="rounded-lg object-cover w-full h-auto aspect-square"/>
				{% endfor %}
				{% if imagesReviews|length == 0 and restaurant.images|length == 0 %}
					<p class="text-center col-span-full text-sm">Aucune image pour ce restaurant.</p>
				{% endif %}
			</my-carousel>
		</section>

		<section class="mt-12">
			<review-list restaurant-id="{{ restaurant.id }}" user-id="{{ app.user ? app.user.id : '' }}" user-username="{{ app.user ? app.user.username : '' }}" is-owner="{{ isOwner ? '1' : '0' }}" editable="true" added="true"></review-list>
		</section>
	</div>

	<script type="module" src="{{ asset('webcomponents/reviews/ReviewList.js') }}"></script>
	<script type="module" src="{{ asset('webcomponents/maps/MapPreview.js') }}"></script>
	<script type="module" src="{{ asset('webcomponents/MyCarousel.js') }}"></script>
	<script type="module" src="{{ asset('webcomponents/ModalConfirm.js') }}"></script>

	<script type="module">
		function initFavoriteBtns() {
document.querySelectorAll('.favorite-btn').forEach(btn => {
if (btn.dataset.init) 
return;


btn.dataset.init = "1";

btn.addEventListener('click', (e) => {
e.preventDefault();
e.stopPropagation();

const id = btn.dataset.id;
const icon = btn.querySelector('i');
const isFav = icon.classList.contains('fa-solid');

fetch (`/api/user/restaurants/${id}/favorite`, {
method: isFav ? 'DELETE' : 'POST'
}).then(res => res.json()).then(() => {
icon.classList.toggle('fa-solid', ! isFav);
icon.classList.toggle('fa-regular', isFav);
});
});
});
}
initFavoriteBtns();
document.addEventListener('alpine:init', initFavoriteBtns);
	</script>
{% endblock %}
