{% extends 'base.html.twig' %}

{% block title %}Mon restaurant
{% endblock %}

{% block body %}
	<h1 class="my-h1 mt-28">Mon restaurant</h1>

	{% for label, messages in app.flashes %}
		{% for message in messages %}
			<div class="w-3/5 mx-auto alert alert-{{ label }}">
				{% autoescape false %}
					{{ message }}
				{% endautoescape %}
			</div>
		{% endfor %}
	{% endfor %}

	{# Message d’avertissement en haut si non validé #}
	{% if not restaurant.isValided %}
		<div class="w-3/4 mx-auto mt-4 mb-6 p-4 bg-orange/10 border-l-4 border-orange text-orange rounded">
			<strong>En attente de validation :</strong>
			Votre restaurant sera vérifié par nos modérateurs avant d’être visible publiquement.
		</div>
	{% endif %}

	{# Contenu entier flouté si non validé #}
	<div class="{% if not restaurant.isValided %}opacity-40 blur-sm pointer-events-none{% endif %}">

		<section class="w-3/4 mx-auto flex items-start gap-16 relative py-4">
			<div class="relative w-1/3">
				{% if restaurant.bannerName %}
					<img src="{{ vich_uploader_asset(restaurant, 'bannerFile') }}" alt="Bannière" class="w-full h-72 object-cover rounded-lg">
				{% else %}
					<div class="w-full h-48 bg-blue rounded-lg"></div>
				{% endif %}

				<div class="absolute -bottom-4 -right-4 bg-white rounded-full shadow-lg w-16 h-16 flex items-center justify-center">
					<img src="{{ asset('images/chef-hat-blue.svg') }}" alt="Icône Gourmy" class="w-10 h-10">
				</div>
			</div>

			<div class="flex-1 flex flex-col gap-4">
				<h2 class="text-3xl font-second text-blue font-medium">{{ restaurant.name }}</h2>
				<p class="text-orange text-sm">{{ restaurant.slug }}</p>
				<p>{{ restaurant.description }}</p>

				{# note #}
				<div class="flex items-center gap-2 text-orange">
					{% set avg = restaurant.averageRating %}
					{% for i in 1..5 %}
						<i class="fa{{ avg >= i ? 's' : (avg >= i - 0.5 ? 's' : 'r') }} fa-star text-sm"></i>
					{% endfor %}
					<span class="text-sm text-black ml-2">
						{{ restaurant.reviews|filter(r => not r.response)|length }}
						avis
					</span>
				</div>
			</div>

			<div x-data="{ open: false }" class="relative ml-auto">
				<button @click="open = !open" class="text-blue text-2xl bg-blue/5 py-2 px-4 rounded-full">
					<i class="fa-solid fa-gear"></i>
				</button>
				<div x-show="open" @click.outside="open = false" class="absolute right-0 mt-2 w-40 bg-white border border-gray-200 rounded shadow-lg z-10">
					<a href="{{ path('app_restaurant_show', { slug: restaurant.slug }) }}" class="block px-4 py-2 hover:bg-gray-100 text-sm">Voir</a>
					<a href="{{ path('app_restaurant_edit') }}" class="block px-4 py-2 hover:bg-gray-100 text-sm">Éditer</a>
					<button type="button" class="block w-full text-left px-4 py-2 hover:bg-red-100 text-sm text-red-600" onclick="confirmRestaurantDeletion()">
						Supprimer
					</button>
				</div>
			</div>
		</section>

		<section class="w-3/4 mx-auto mt-8">
			<script type="module" src="{{ asset('webcomponents/TabView.js') }}"></script>
			<tab-view tabs='[
				{
					"title": "Infos",
					"content": {{ include("restaurant/profile/_infos.html.twig", { restaurant: restaurant })|json_encode|raw }}
				},
				{
					"title": "Avis",
					"content": "<restaurant-review-manager restaurant-id=\"{{ restaurant.id }}\" csrf=\"{{ csrf_token(' review_response') }}\"></restaurant-review-manager>"
				},
				{
					"title": "images",
					"content": {{ include("restaurant/profile/_photos.html.twig", { reviews: restaurant.reviews, images: restaurant.images })|json_encode|raw }}
				}
			]'></tab-view>
		</section>

	</div>

	<script type="module" src="{{ asset('webcomponents/ModalConfirm.js') }}"></script>
	<modal-confirm id="delete-confirm"></modal-confirm>
	<script>
		function confirmRestaurantDeletion() {
const modal = document.getElementById('delete-confirm');
modal.show("Voulez-vous vraiment supprimer ce restaurant ?", () => {
window.location.href = "{{ path('app_restaurant_delete') }}";
});
}
	</script>
{% endblock %}
