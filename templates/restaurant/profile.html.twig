{% extends 'base.html.twig' %}

{% block title %}Mon restaurant
{% endblock %}

{% block body %}
	<h1 class="my-h1 mt-28 text-center px-4">Mon restaurant</h1>

	{# Flashs #}
	{% for label, messages in app.flashes %}
		{% for message in messages %}
			<div class="max-w-3xl w-11/12 mx-auto mt-4 alert alert-{{ label }}">
				{% autoescape false %}
					{{ message }}
				{% endautoescape %}
			</div>
		{% endfor %}
	{% endfor %}

	{# Alerte validation #}
	{% if not restaurant.isValided %}
		<div class="max-w-5xl w-11/12 mx-auto mt-4 mb-6 p-4 bg-orange/10 border-l-4 border-orange text-orange rounded">
			<strong>En attente de validation :</strong>
			Votre restaurant sera vérifié par nos modérateurs avant d’être visible publiquement.
		</div>
	{% endif %}

	<div
		class="{% if not restaurant.isValided %}opacity-40 blur-sm pointer-events-none{% endif %}">
		{# SECTION TOP: image + infos + actions #}
		<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
			<div class="relative grid grid-cols-1 lg:grid-cols-12 gap-6 sm:gap-8 items-start">
				<div x-data="{ open:false }" class="absolute top-2 right-6 sm:top-3 sm:right-3 lg:top-4 lg:right-4 z-30">
					<div class="relative">
						<button @click="open = !open" :aria-expanded="open.toString()" aria-haspopup="menu" class="text-blue text-xl sm:text-2xl bg-paleBlue lg:bg-blue/5 py-2 px-4 rounded-full">
							<i class="fa-solid fa-gear"></i>
						</button>
						<div x-show="open" @click.outside="open = false" x-transition.opacity.duration.150ms role="menu" class="absolute right-0 mt-2 w-44 bg-white border border-gray-200 rounded shadow-lg z-40">
							<a href="{{ path('app_restaurant_show', { slug: restaurant.slug }) }}" role="menuitem" class="block px-4 py-2 hover:bg-gray-100 text-sm">Voir</a>
							<a href="{{ path('app_restaurant_edit') }}" role="menuitem" class="block px-4 py-2 hover:bg-gray-100 text-sm">Éditer</a>
							<button type="button" role="menuitem" class="block w-full text-left px-4 py-2 hover:bg-red-100 text-sm text-red-600" onclick="confirmRestaurantDeletion()">
								Supprimer
							</button>
						</div>
					</div>
				</div>


				{# Visuel #}
				<div class="relative lg:col-span-4 w-full">
					{% if restaurant.bannerName %}
						<img src="{{ vich_uploader_asset(restaurant, 'bannerFile') }}" alt="Bannière" class="w-11/12 mx-auto sm:w-full h-56 sm:h-64 md:h-72 lg:h-80 object-cover rounded-lg">
					{% else %}
						<div class="w-full h-40 sm:h-48 bg-blue/10 rounded-lg"></div>
					{% endif %}

					<div class="absolute -bottom-4 right-1 sm:-bottom-5 sm:-right-5 bg-white rounded-full shadow-lg w-14 h-14 sm:w-16 sm:h-16 flex items-center justify-center">
						<img src="{{ asset('images/chef-hat-blue.svg') }}" alt="Icône Gourmy" class="w-9 h-9 sm:w-10 sm:h-10">
					</div>
				</div>

				{# Infos #}
				<div class="lg:col-span-7 flex flex-col gap-3 sm:gap-4">
					<h2 class="text-2xl sm:text-3xl font-second text-blue font-medium">{{ restaurant.name }}</h2>
					<p class="text-orange text-xs sm:text-sm">{{ restaurant.slug }}</p>
					<p class="text-sm sm:text-base leading-relaxed">{{ restaurant.description }}</p>

					<div class="flex items-center gap-2 text-orange">
						{% set avg = restaurant.averageRating %}
						{% for i in 1..5 %}
							<i class="fa{{ avg >= i ? 's' : (avg >= i - 0.5 ? 's' : 'r') }} fa-star text-sm"></i>
						{% endfor %}
						<span class="text-sm text-black ml-2">
							{{ restaurant.reviews|filter(r => not r.response)|length }}
							avis
						</span>
					</div>
				</div>
			</div>
		</section>

		{# TABS #}
		<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6 sm:mt-8">
			<script type="module" src="{{ asset('webcomponents/TabView.js') }}"></script>

			<tab-view>
				<tab-item title="Infos" active>
					{{ include("restaurant/profile/_infos.html.twig", { restaurant: restaurant })|raw }}
				</tab-item>

				<tab-item title="Avis">
					<restaurant-review-manager restaurant-id="{{ restaurant.id }}" csrf="{{ csrf_token('review_response') }}"></restaurant-review-manager>
				</tab-item>

				<tab-item title="Images">
					{{ include("restaurant/profile/_photos.html.twig", { reviews: restaurant.reviews, images: restaurant.images })|raw }}
				</tab-item>

				<tab-item title="Statistiques">
					{{ include("restaurant/profile/_stats.html.twig", {
            restaurant: restaurant,
            nbReviews: nbReviews,
            avgRating: avgRating,
            nbFavorites: nbFavorites,
            chart: chart
          })|raw }}
				</tab-item>
			</tab-view>
		</section>
	</div>

	<script type="module" src="{{ asset('webcomponents/ModalConfirm.js') }}"></script>
	<modal-confirm id="delete-confirm"></modal-confirm>
	<script>
		function confirmRestaurantDeletion() {
const modal = document.getElementById('delete-confirm');
modal.show("Voulez-vous vraiment supprimer ce restaurant ?", () => {
window.location.href = "{{ path('app_restaurant_delete') }}";
});
}
	</script>
{% endblock %}
