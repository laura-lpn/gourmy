{% extends 'base.html.twig' %}

{% block title %}Profil
{% endblock %}

{% block body %}
	<div
		class="mt-28">

		{# Flashs #}
		{% for label, messages in app.flashes %}
			{% for message in messages %}
				<div class="max-w-3xl w-11/12 mx-auto alert alert-{{ label }} mb-3">
					{% autoescape false %}
						{{ message }}
					{% endautoescape %}
				</div>
			{% endfor %}
		{% endfor %}

		{# En-tête profil #}
		<section class="max-w-7xl w-11/12 md:w-5/6 lg:w-3/4 mx-auto px-4 sm:px-6 lg:px-8 py-4 relative">
			<div
				class="relative grid grid-cols-1 lg:grid-cols-12 items-center gap-6 sm:gap-8">

				{# Avatar #}
				<div class="lg:col-span-4 flex justify-center lg:justify-start">
					{% if user.avatarName %}
						<img src="{{ vich_uploader_asset(user, 'avatarFile') }}" alt="Avatar de {{ user.username }}" class="rounded-full object-cover w-28 h-28 sm:w-36 sm:h-36 md:w-44 md:h-44 lg:w-64 lg:h-64">
					{% else %}
						<img src="{{ asset('images/avatar-placeholder.png') }}" alt="Avatar par défaut" class="rounded-full object-cover w-40 h-40 lg:w-56 lg:h-56">
					{% endif %}
				</div>

				{# Infos utilisateur #}
				<div class="lg:col-span-7 flex flex-col mx-auto lg:mx-0">
					<h1 class="font-second text-blue text-2xl sm:text-3xl lg:text-4xl font-medium leading-tight">
						{{ user.firstName ~ ' ' ~ user.lastName }}
					</h1>
					<p class="text-orange font-medium text-sm sm:text-base">@{{ user.username|lower }}</p>

					<p class="text-xs sm:text-sm mt-2 leading-relaxed">
						Classement général :
						<strong class="font-medium text-blue">{{ rank }}<sup>e</sup>
						</strong>
						sur
						{{ all_users_count }}
						utilisateurs
					</p>

					<div class="mt-3 sm:mt-4 flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4">
						<button id="share-profile" type="button" class="btn-secondary flex items-center gap-2 text-sm" data-url="{{ app.request.scheme ~ '://' ~ app.request.host ~ path('app_user_show', { username: user.username|lower }) }}">
							<i class="fa-solid fa-share-nodes"></i>
							Partager mon profil
						</button>
						<p id="copy-feedback" class="text-green-600 text-sm hidden">Lien copié !</p>
					</div>
				</div>

				<div x-data="{ open: false }" class="absolute top-0 right-0 lg:static lg:col-span-1 lg:justify-self-end z-20">
					<div class="relative">
						<button title="Paramètres" @click="open = !open" :aria-expanded="open.toString()" aria-haspopup="menu" class="text-blue text-xl sm:text-2xl bg-blue/5 py-2 px-4 rounded-full">
							<i class="fa-solid fa-gear"></i>
						</button>

						<div x-show="open" x-transition.opacity.duration.150ms @click.outside="open = false" role="menu" class="absolute right-0 mt-2 w-44 bg-white border border-gray-200 rounded shadow-lg z-30">
							<a href="{{path('app_logout')}}" role="menuitem" class="block px-4 py-2 hover:bg-gray-100 text-sm">Déconnexion</a>
							<a href="{{ path('app_user_edit') }}" role="menuitem" class="block px-4 py-2 hover:bg-gray-100 text-sm">Éditer</a>
							<button type="button" role="menuitem" class="block w-full text-left px-4 py-2 hover:bg-red-100 text-sm text-red-600" onclick="confirmDeletion()">
								Supprimer
							</button>
						</div>
					</div>
				</div>

			</div>
		</section>

		{# Onglets #}
		<script type="module" src="{{ asset('webcomponents/TabView.js') }}"></script>
		<section class="max-w-7xl w-11/12 lg:w-3/4 mx-auto px-4 sm:px-6 lg:px-8 mt-6">
			<tab-view>
				<tab-item title="Photos" active>
					{{ include("user/profile/_photos.html.twig", { photos: photos })|raw }}
				</tab-item>

				<tab-item title="Roadtrips">
					{{ include("user/profile/_roadtrips.html.twig", { isPublic: false })|raw }}
				</tab-item>

				<tab-item title="Avis">
					<review-list user-id="{{ app.user ? app.user.id : ' ' }}" editable="true"></review-list>
				</tab-item>

				<tab-item title="Favoris">
					<user-favorites></user-favorites>
				</tab-item>

				<tab-item title="Badges">
					{{ include("user/profile/_badges.html.twig")|raw }}
				</tab-item>

				<tab-item title="Carte">
					{{ include("user/profile/_map.html.twig")|raw }}
				</tab-item>
			</tab-view>
		</section>

	</div>

	<script type="module" src="{{ asset('webcomponents/ModalConfirm.js') }}"></script>
	<modal-confirm id="delete-confirm"></modal-confirm>
	<script>
		function confirmDeletion() {
			const modal = document.getElementById('delete-confirm');
			modal.show('Voulez-vous vraiment supprimer votre compte ?', () => {
			window.location.href = "{{ path('app_user_delete') }}";
			});
			}

			document.getElementById('share-profile') ?. addEventListener('click', () => {
			const url = document.getElementById('share-profile').dataset.url;
			navigator.clipboard.writeText(url).then(() => {
			const feedback = document.getElementById('copy-feedback');
			feedback.classList.remove('hidden');
			setTimeout(() => feedback.classList.add('hidden'), 2000);
			});
		});
	</script>
{% endblock %}