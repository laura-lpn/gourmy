{% set current_route = app.request.attributes.get('_route') %}

<header class="fixed top-0 z-20 w-full py-3">
  <div class="mx-4 sm:mx-8 bg-white/90 backdrop-blur py-3 px-4 sm:px-6 rounded-2xl">
    <div class="flex items-center justify-between">
      <!-- Logo -->
      <a href="{{ path('app_home') }}" class="shrink-0 flex items-center gap-3">
        <img src="{{ asset('images/favicon.svg') }}" alt="Logo Gourmy" class="h-12 sm:h-14">
      </a>

      <!-- Nav desktop (désormais à partir de lg) -->
      <nav class="hidden lg:flex gap-8 font-second text-md items-center">
        <a class="my-nav {{ current_route == 'app_home' ? 'my-nav-actif' }}" href="{{ path('app_home') }}">Accueil</a>
        <a class="my-nav {{ current_route == 'app_roadtrips' ? 'my-nav-actif' }}" href="{{ path('app_roadtrips') }}">Nos Roadtrips</a>
        <a class="my-nav {{ current_route == 'app_restaurant_list' ? 'my-nav-actif' }}" href="{{ path('app_restaurant_list') }}">Nos Partenaires</a>
        <a class="my-nav{{ current_route in ['app_restaurateur','app_restaurant_profile'] ? ' my-nav-actif' }}" href="{{ path('app_restaurateur') }}">Espace Restaurateur</a>

        {% if is_granted('ROLE_USER') %}
          <a class="my-nav{{ current_route == 'app_user_profile' ? ' my-nav-actif' }}" title="Mon Profil" href="{{ path('app_user_profile') }}">
            <i class="fa-regular fa-user"></i>
          </a>
        {% else %}
          <a class="my-nav{{ current_route == 'app_login' ? ' my-nav-actif' }}" href="{{ path('app_login') }}">Connexion</a>
          <a class="my-nav{{ current_route == 'app_register' ? ' my-nav-actif' }}" href="{{ path('app_register') }}">Inscription</a>
        {% endif %}
      </nav>

      <!-- Bouton burger (mobile & tablette) -->
      <button
        id="burger-btn"
        class="lg:hidden inline-flex items-center justify-center"
        aria-expanded="false"
        aria-controls="mobile-menu"
        aria-label="Ouvrir le menu"
      >
        <i class="fa-solid fa-bars text-xl" data-icon="open"></i>
        <i class="fa-solid fa-xmark text-xl hidden" data-icon="close"></i>
      </button>
    </div>

    <!-- Menu mobile (mobile & tablette) -->
    <div
      id="mobile-menu"
      class="lg:hidden hidden mt-3 px-2 pb-2"
      role="dialog"
      aria-modal="true"
    >
      <div class="overflow-hidden transform transition-all duration-250 ease-out opacity-0 -translate-y-2">
    		<nav class="flex flex-col font-second text-base">
          <a class="my-nav px-5 py-3 {{ current_route == 'app_home' ? 'my-nav-actif' }}" href="{{ path('app_home') }}">Accueil</a>
          <a class="my-nav px-5 py-3 {{ current_route == 'app_roadtrips' ? 'my-nav-actif' }}" href="{{ path('app_roadtrips') }}">Nos Roadtrips</a>
          <a class="my-nav px-5 py-3 {{ current_route == 'app_restaurant_list' ? 'my-nav-actif' }}" href="{{ path('app_restaurant_list') }}">Nos Partenaires</a>
          <a class="my-nav px-5 py-3{{ current_route in ['app_restaurateur','app_restaurant_profile'] ? ' my-nav-actif' }}" href="{{ path('app_restaurateur') }}">Espace Restaurateur</a>

          {% if is_granted('ROLE_USER') %}
            <a class="my-nav px-5 py-3{{ current_route == 'app_user_profile' ? ' my-nav-actif' }}" href="{{ path('app_user_profile') }}">
              <i class="fa-regular fa-user mr-2"></i> Mon Profil
            </a>
          {% else %}
            <a class="my-nav px-5 py-3{{ current_route == 'app_login' ? ' my-nav-actif' }}" href="{{ path('app_login') }}">Connexion</a>
            <a class="my-nav px-5 py-3{{ current_route == 'app_register' ? ' my-nav-actif' }}" href="{{ path('app_register') }}">Inscription</a>
          {% endif %}
        </nav>
      </div>
    </div>
  </div>
</header>

<script>
  (function () {
    const btn = document.getElementById('burger-btn');
    const menu = document.getElementById('mobile-menu');
    if (!btn || !menu) return;

    const panel = menu.firstElementChild;
    const openIcon  = btn.querySelector('[data-icon="open"]');
    const closeIcon = btn.querySelector('[data-icon="close"]');
    let closing = false;

    const afterClose = () => {
      menu.classList.add('hidden');
      menu.setAttribute('aria-hidden', 'true');
      closing = false;
    };

    const setOpen = (open) => {
      if (open) {
        if (!menu.classList.contains('hidden')) return;
        menu.classList.remove('hidden');
        menu.setAttribute('aria-hidden', 'false');
        panel.classList.add('opacity-0', '-translate-y-2');
        panel.classList.remove('opacity-100', 'translate-y-0');

        requestAnimationFrame(() => {
          panel.classList.remove('opacity-0', '-translate-y-2');
          panel.classList.add('opacity-100', 'translate-y-0');
        });

        openIcon.classList.add('hidden');
        closeIcon.classList.remove('hidden');
        btn.setAttribute('aria-expanded', 'true');
        document.body.classList.add('overflow-hidden');
      } else {
        if (menu.classList.contains('hidden') || closing) return;
        closing = true;
        panel.classList.add('opacity-0', '-translate-y-2');
        panel.classList.remove('opacity-100', 'translate-y-0');

        const onEnd = (e) => {
          if (e.target !== panel) return;
          panel.removeEventListener('transitionend', onEnd);
          afterClose();
        };
        panel.addEventListener('transitionend', onEnd);

        openIcon.classList.remove('hidden');
        closeIcon.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
        document.body.classList.remove('overflow-hidden');
      }
    };

    btn.addEventListener('click', () => {
      const isOpen = btn.getAttribute('aria-expanded') === 'true';
      setOpen(!isOpen);
    });

    menu.addEventListener('click', (e) => {
      const a = e.target.closest('a');
      if (a) setOpen(false);
    });

    document.addEventListener('click', (e) => {
      const isOpen = btn.getAttribute('aria-expanded') === 'true';
      if (!isOpen) return;
      if (!menu.contains(e.target) && !btn.contains(e.target)) {
        setOpen(false);
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && btn.getAttribute('aria-expanded') === 'true') {
        setOpen(false);
      }
    });
  })();
</script>