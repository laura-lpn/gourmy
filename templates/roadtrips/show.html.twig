{% extends 'base.html.twig' %}

{% block title %}
	{{ roadtrip.title }}
{% endblock %}

{% block body %}
	<div class="mt-28 max-w-5xl mx-auto px-4">
		<h1 class="my-h1 text-center">{{ roadtrip.title }}</h1>

		{% for label, messages in app.flashes %}
			{% for message in messages %}
				<div class="alert alert-{{ label }}">
					{% autoescape false %}
						{{ message }}
					{% endautoescape %}
				</div>
			{% endfor %}
		{% endfor %}

		{% set points = [] %}
		{% for step in roadtrip.steps %}
			{% if step.restaurant %}
				{% set points = points|merge([{
            lat: step.restaurant.latitude,
            lng: step.restaurant.longitude,
            name: step.restaurant.name
        }]) %}
			{% endif %}
		{% endfor %}

		<div
			class="flex gap-6 mb-8">
			{# Colonne gauche : images des restaurants #}
			<div class="w-2/5 flex flex-col gap-4">
				{% set images = roadtrip.steps
      |filter(step => step.restaurant and step.restaurant.bannerName)
      |map(step => vich_uploader_asset(step.restaurant, 'bannerFile'))
      |slice(0, 3) %}

				{% if images is not empty %}
					{% for image in images %}
						<img src="{{ image }}" alt="Restaurant étape" class="w-full h-48 object-cover rounded-xl">
					{% endfor %}
				{% else %}
					<p class="text-sm text-gray-500 italic">Aucune image disponible.</p>
				{% endif %}
			</div>

			{# Colonne droite : la carte #}
			<div class="w-3/5">
				<script type="module" src="{{ asset('webcomponents/maps/MapRoadtrip.js') }}"></script>
				<map-roadtrip points='{{ points|json_encode|e("html_attr") }}'></map-roadtrip>
			</div>
		</div>

		<div class="bg-white rounded-xl shadow-main p-6 space-y-4">
			<p class="text-gray-800 leading-relaxed">{{ roadtrip.description }}</p>

			<div>
				<h2 class="my-h2 text-left mb-3">Étapes</h2>

				<div class="space-y-4">
					{% for step in roadtrip.steps %}
						<div class="p-4 bg-gray-50 rounded-lg border border-gray-200 space-y-2">
							<p class="font-second text-lg text-blue">{{ step.town }}</p>
							<p class="text-sm text-gray-600">Nombre de repas :
								<strong>{{ step.meals }}</strong>
							</p>
							{% if step.cuisine is not empty %}
								<div class="flex flex-wrap gap-2 mt-1">
									{% for type in step.cuisine %}
										<span class="px-2 py-1 text-xs rounded-full bg-blue/10 text-blue border border-blue">
											{{ type.name }}
										</span>
									{% endfor %}
								</div>
							{% endif %}
							{% if step.restaurant %}
								<p class="text-sm text-gray-600">Restaurant associé :
									<a href="{{ path('app_restaurant_show', {slug: step.restaurant.slug}) }}" class="text-blue hover:underline">
										{{ step.restaurant.name }}
									</a>
								</p>
							{% endif %}
						</div>
					{% endfor %}
				</div>
			</div>
		</div>

		<div class="text-center mt-8">
			<a href="{{ path('app_roadtrips') }}" class="btn-secondary inline-block">
				← Retour aux roadtrips
			</a>
		</div>
	</div>
{% endblock %}
