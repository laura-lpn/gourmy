{% extends 'base.html.twig' %}

{% block title %}
	{{ roadtrip.title }}
{% endblock %}

{% block meta %}
	<meta name="description" content="{{ roadtrip.description|length > 150 ? roadtrip.description|slice(0,150) ~ '...' : roadtrip.description }}">
	<meta property="og:title" content="{{ roadtrip.title }} – Roadtrip culinaire Gourmy">
	<meta property="og:description" content="{{ roadtrip.description|length > 200 ? roadtrip.description|slice(0,200) ~ '...' : roadtrip.description }}">
	{% set ogImage = roadtrip.steps
    |map(step => step.restaurants|first)
    |filter(r => r and r.bannerName)
    |map(r => vich_uploader_asset(r, 'bannerFile'))
    |first %}
	{% if ogImage %}
		<meta property="og:image" content="{{ ogImage }}">
	{% else %}
		<meta property="og:image" content="{{ asset('images/pages/roadtrips.jpg') }}">
	{% endif %}
{% endblock %}

{% block body %}
	<div
		class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-10 mt-28">

		{# Flashs #}
		{% for label, messages in app.flashes %}
			{% for message in messages %}
				<div class="alert alert-{{ label }} mb-4">
					{% autoescape false %}
						{{ message }}
					{% endautoescape %}
				</div>
			{% endfor %}
		{% endfor %}

		{# HERO local (images + titre/desc) #}
		<section class="relative flex flex-col md:flex-row gap-6 sm:gap-8 mb-10 sm:mb-12 items-start">
			<button class="absolute top-2 right-2 sm:top-3 sm:right-3 md:top-4 md:right-4 text-white text-base sm:text-lg z-20 bg-orange rounded-full px-2 py-1 favorite-btn" data-id="{{ roadtrip.id }}" aria-label="Ajouter aux favoris" title="Ajouter aux favoris">
				<i class="{{ isFavorite ? 'fa-solid' : 'fa-regular' }} fa-heart"></i>
			</button>

			{# Collage d’images #}
			<div class="md:w-5/12 w-full flex flex-col gap-3 sm:gap-4">
				{% set images = roadtrip.steps
          |map(step => step.restaurants|first)
          |filter(r => r and r.bannerName)
          |map(r => vich_uploader_asset(r, 'bannerFile'))
          |slice(0, 3) %}

				{% if images is not empty %}
					{% set count = images|length %}
					{% if count == 1 %}
						<img src="{{ images[0] }}" alt="Image restaurant" class="w-full h-56 sm:h-72 lg:h-80 object-cover rounded-xl" loading="lazy">
					{% elseif count == 2 %}
						<div class="flex flex-col gap-3 sm:gap-4 h-56 sm:h-72 lg:h-80">
							<img src="{{ images[0] }}" alt="Image restaurant" class="w-full h-1/2 object-cover rounded-xl" loading="lazy">
							<img src="{{ images[1] }}" alt="Image restaurant" class="w-full h-1/2 object-cover rounded-xl" loading="lazy">
						</div>
					{% elseif count == 3 %}
						<div class="flex flex-col gap-3 sm:gap-4 h-56 sm:h-72 lg:h-80">
							<img src="{{ images[0] }}" alt="Image restaurant" class="w-full h-1/2 object-cover rounded-xl" loading="lazy">
							<div class="flex gap-3 sm:gap-4 h-1/2">
								<img src="{{ images[1] }}" alt="Image restaurant" class="w-1/2 object-cover rounded-xl" loading="lazy">
								<img src="{{ images[2] }}" alt="Image restaurant" class="w-1/2 object-cover rounded-xl" loading="lazy">
							</div>
						</div>
					{% endif %}
				{% else %}
					<p class="text-sm italic text-gray-500">Aucune image disponible pour ce roadtrip.</p>
				{% endif %}
			</div>

			{# Titre + Description #}
			<div class="md:w-7/12 w-full flex flex-col gap-3 sm:gap-4">
				<h1 class="font-second text-blue text-2xl sm:text-3xl lg:text-4xl font-medium leading-tight">
					{{ roadtrip.title }}
				</h1>
				<p class="text-gray-800 leading-relaxed text-sm sm:text-base">
					{{ roadtrip.description }}
				</p>
			</div>
		</section>

		{# Carte #}
		<section class="mb-10 sm:mb-12">
			<h2 class="text-lg sm:text-xl font-medium flex gap-4 sm:gap-6 items-center font-second text-orange mb-3 sm:mb-4">
				<span class="h-0.5 rounded-md bg-orange w-6 sm:w-8 block"></span>
				Carte du roadtrip
			</h2>

			{% set points = [] %}
			{% for step in roadtrip.steps %}
				{% for restaurant in step.restaurants %}
					{% set points = points|merge([{
            lat: restaurant.latitude,
            lng: restaurant.longitude,
            name: restaurant.name,
            photo: restaurant.bannerName ? vich_uploader_asset(restaurant, 'bannerFile') : null
          }]) %}
				{% endfor %}
			{% endfor %}

			<div class="w-full h-64 sm:h-80 lg:h-96 rounded-xl overflow-hidden">
				<script type="module" src="{{ asset('webcomponents/maps/MapRoadtrip.js') }}"></script>
				<map-roadtrip points="{{ points|json_encode|e('html_attr') }}" api-key="{{ google_maps_api_key }}"></map-roadtrip>
			</div>
		</section>

		{# Étapes #}
		<section class="mb-10 sm:mb-12 space-y-6 sm:space-y-8">
			<h2 class="text-lg sm:text-xl font-medium flex gap-4 sm:gap-6 items-center font-second text-blue">
				<span class="h-0.5 rounded-md bg-blue w-6 sm:w-8 block"></span>
				Étapes du roadtrip
			</h2>

			{% for step in roadtrip.steps %}
				<div class="bg-orange/5 rounded-xl p-4 sm:p-6">
					<h3 class="text-base sm:text-lg font-second text-orange font-medium flex items-center gap-3 sm:gap-4 mb-1.5 sm:mb-2">
						<span class="h-0.5 w-5 sm:w-6 bg-orange rounded-md block"></span>
						{{ step.town }}
					</h3>

					<p class="text-xs sm:text-sm mb-3 sm:mb-4">
						Repas prévus :
						<strong class="font-medium">{{ step.meals }}</strong>
					</p>

					{% if step.cuisine is not empty %}
						<div class="flex flex-wrap gap-2 mb-4">
							{% for type in step.cuisine %}
								<span class="px-2 py-1 text-[11px] sm:text-xs rounded-full bg-blue text-white">
									{{ type.name }}
								</span>
							{% endfor %}
						</div>
					{% endif %}

					{% if step.restaurants is not empty %}
						<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
							{% for restaurant in step.restaurants %}
								{{ include('restaurant/_card.html.twig', {
                  restaurant: restaurant,
                  clickable: true,
                  compact: true
                }) }}
							{% endfor %}
						</div>
					{% endif %}
				</div>
			{% endfor %}
		</section>

		{# Retour #}
		<div class="text-center">
			<a href="{{ path('app_roadtrips') }}" class="btn-secondary inline-block">
				← Retour aux roadtrips
			</a>
		</div>

	</div>

	<script type="module">
		function initFavoriteBtns() {
document.querySelectorAll('.favorite-btn').forEach(btn => {
if (btn.dataset.init) 
return;



btn.dataset.init = "1";

btn.addEventListener('click', async (e) => {
e.preventDefault();
e.stopPropagation();

const id = btn.dataset.id;
const icon = btn.querySelector('i');
const isFav = icon.classList.contains('fa-solid');

try {
const res = await fetch (`/api/user/roadtrips/${id}/favorite`, {
method: isFav ? 'DELETE' : 'POST',
headers: {
'X-Requested-With': 'XMLHttpRequest'
}
});
if (! res.ok) 
throw new Error('Network');



icon.classList.toggle('fa-solid', ! isFav);
icon.classList.toggle('fa-regular', isFav);
} catch (err) { // Optionnel: afficher un toast/flash
console.warn('Impossible de mettre à jour les favoris.');
}
});
});
}
initFavoriteBtns();
document.addEventListener('alpine:init', initFavoriteBtns);
	</script>
{% endblock %}
